<!DOCTYPE html>
<html lang="en">
<head>
        <title>Elixir: Debugging and Inspection - weeks 9 and 10</title>
        <meta charset="utf-8" />
        <link rel="icon" type="image/png" href="./theme/images/fire.png">
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
        <link href="./feed.rss" type="application/rss+xml" rel="alternate" title="machine burning RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <div class="social">
				    <a href="./feed.rss" rel="alternate">
					    <span></span>
				    </a>

				    <a href="http://github.com/brunoro">
					    <span></span>
				    </a>
				    <a href="http://last.fm/user/gbrunoro">
					    <span></span>
				    </a>
				    <a href="http://androidsdreaminpixels.tumblr.com">
					    <span></span>
				    </a>
				    <a href="http://soundcloud.com/beise">
					    <span></span>
				    </a>
                </div>
                <h1><a href="."><span id="title0">machine burning</span><span id="title1">machine burning</span><span id="title2">machine burning</span> </a></h1>
                </ul></nav>
        </header><!-- /#banner -->
        
<section id="content" class="body">    
<article>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to Elixir: Debugging and Inspection - weeks 9 and 10">Elixir: Debugging and Inspection - weeks 9 and 10</a></h1>  </header>
<div class="post-info">
        <abbr class="published" title="2013-08-26T00:00:00+02:00">
                2013-08-26
        </abbr>

<p>in <a href="./category/gsoc2013.html">gsoc2013</a>. </p>
<p>tags: <a href="./tag/gsoc2013.html">gsoc2013</a><a href="./tag/elixir.html">elixir</a></p></div><!-- /.post-info -->        <div class="entry-content">
        <p>After last weeks' drama about anonymous functions, we could say that everything went well: the final
code wouldn't differ much from the current <code>defdebug</code> and <code>case</code> expressions.
On weeks 9 and 10 I've finally managed to write code to make all runtime tests pass, dealt with with 
non-debugged code interoperability, did some module name refactoring and rambled bit about a simple CLI.</p>
<h3>Mystery on PIDland</h3>
<p>The trouble of nested eval calls must have caused me some kind of <strong>evalception</strong> trauma.
This last test related to the last features I've had implemented showed that:</p>
<div class="highlight"><pre>defdebug msg_f2 do
  pid <span class="o">=</span> spawn fn <span class="o">-&gt;</span>
    receive do
      <span class="p">{</span> from<span class="p">,</span> <span class="o">:</span>msg <span class="p">}</span> <span class="o">-&gt;</span>
        from <span class="o">&lt;-</span> <span class="o">:</span>ack
    end
  end
  pid <span class="o">&lt;-</span> <span class="p">{</span> self<span class="p">,</span> <span class="o">:</span>msg <span class="p">}</span>
  receive do
    <span class="o">:</span>ack <span class="o">-&gt;</span> <span class="o">:</span>ok
  end
end
</pre></div>


<p>Running this piece of code would either result in a perfect <code>:ok</code> or on a process hanging on a <code>receive</code>
expression with an <code>:EXIT</code> message from a process with an unknown PID. Deeply disturbing.
Inspecting stuff on that code revealed another problem: the escaping functions wouldn't
iterate deeply on data structures, so that <code>{ self, :msg }</code> wouldn't get escaped properly, and that
<code>self</code> PID would never get matched on receive. Bingo!</p>
<h3>Escape to the hills</h3>
<p>On the beginning of the project I thought that escaping was the lesser of my concerns. 
That, however, proved to be wrong, as PIDs and then anonymous functions can't be injected inside an Elixir
quoted syntax tree.
My first solution, always escaping the result of evaluated code, seemed to be definitive until interoperability
with non-debugged code became a concern.
One solution was obvious at this point: evaluated values should always be the same as the results yielded from
a non-debugging run, so escaping should be done before evaluating!</p>
<p>At that point, <code>Runner.eval_quoted</code> had some code extracted that became <code>Runner.escape_and_eval</code>.
Some function calls were changed, as not every eval call on the runtime would require escaping.
For my surprise, after solving the escaping related problems, that message passing test passed and we got
0 failures (:</p>
<h3>Major Tom to Ground Control</h3>
<p>The design of a CLI involved creating a <code>Controller</code> module that will interact with <code>Runner</code>, giving
the heads up for process execution.
But what about our good old <code>Controller</code> module, that only serves to the purpose of keeping the 
state of a process? Well, guess what, it is now called <code>StateServer</code>.</p>
<p>The CLI is very simple: when a <code>Controller</code> process gets notified by a running process that
an expression is about to be executed, an IO loop starts and a command is read. 
The running process has to wait for authorization before continuing, that way we will be able to
implement more advanced stepping and breakpoints by tweaking the protocol between those processes.</p>
        </div><!-- /.entry-content -->

</article>
</section>
        <section id="extras" class="body">
       </section><!-- /#extras -->

        <footer id="about" class="body">
            <p>Powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>; theme based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a></p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-32411032-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>